# -*- coding: utf-8 -*-

db = DAL('mysql://<user>:<password>@<server>/<database name>', migrate=False)
from gluon.tools import Crud
crud = Crud(db)

## (optional) optimize handling of static files
response.optimize_css = 'concat,minify,inline'
response.optimize_js = 'concat,minify,inline'

userTypes = ('Student','Teacher','Administrator','Other')
deviceTypes = ('Laptop','Desktop','Projector','Printer','Document Camera','Interactive Board','Tablet','iPod','Other')
statusTypes = ('Checked Out','Warranty','Insurance','Storage','Missing','MS Loaner','HS Loaner')


db.define_table('devices',
Field('Inventory_Number','string',unique=True),\
Field('Serial_Number','string'),\
Field('Bag_Tag','string'),\
Field('Status','string',requires=IS_IN_SET(statusTypes,zero='Choose Status')),\
Field('User','string'),\
Field('User_Type','string',requires=IS_IN_SET(userTypes,zero='Choose Type')),\
Field('Device_Type','string',requires=IS_IN_SET(deviceTypes,zero='Choose Type')),\
Field('Manufacturer','string'),\
Field('Model','string'),\
Field('Campus','string'),\
Field('Room','string'),\
Field('On_Network','boolean'),\
Field('Notes','text')\
)

class IS_CHARGE(object):
    def __init__(self):
        pass
    def __call__(self, value):
        try:
            if value == '':
                return (value, None)
            line = value.split(':')
            if len(line) != 2:
                raise RuntimeError, 'Incorrect number of :'
            float(line[1])
            return (value, None)
        except:
            return (value, 'Must be <text description>:<numeric cost>')

db.define_table('charges',
Field('Inventory_Number','string', requires=IS_IN_DB(db,'devices.Inventory_Number')),\
Field('User','string', requires=IS_NOT_EMPTY()),\
Field('Amount_Paid','double', default=0.0, requires=IS_NOT_EMPTY()),\
Field('Charges','list:string', requires=IS_LIST_OF(IS_CHARGE())),\
Field('Notes','text')
)

# Authentication - http://www.web2pyslices.com/slice/show/1468/how-to-set-up-web2py-ldap-with-windows-active-directory
from gluon.tools import Auth
auth = Auth(db, hmac_key=Auth.get_or_create_key())
auth.define_tables(username=True)
auth.settings.create_user_groups=False
# all we need is login
auth.settings.actions_disabled=['register','change_password','request_reset_password','retrieve_username','profile']
# you don't have to remember me
auth.settings.remember_me_form = False
# ldap authentication and not save password on web2py
from gluon.contrib.login_methods.ldap_auth import ldap_auth
auth.settings.login_methods = [ldap_auth(mode='ad',
allowed_groups = ['Domain Group1','Domain Group2'],
bind_dn = 'CN=Admin User,OU=baseou,DC=example,DC=com',
bind_pw = 'pass',
group_dn = 'OU=Domain Groups,OU=baseou,DC=example,DC=com',
group_name_attrib = 'cn',
group_member_attrib = 'member',
group_filterstr = 'objectClass=Group',
server='server.example.com',
base_dn='OU=baseou,DC=example,DC=com')]

# set Title for all pages
response.title = 'Change Me!'

#Set header for charges report
reportheader = 'Technology Equipment Check-in Form'

# Set Quick Search fields
searches = ['Inventory_Number','Serial_Number','Bag_Tag']
chargeSearches = ['Inventory_Number','User']
